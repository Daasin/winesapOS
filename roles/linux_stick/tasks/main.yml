---
- name: Disable automatic package list updates
  lineinfile:
    path: "{{ item }}"
    regexp: '^APT::Periodic::Update-Package-Lists'
    line: 'APT::Periodic::Update-Package-Lists "0";'
  loop:
    - /etc/apt/apt.conf.d/10periodic
    - /etc/apt/apt.conf.d/20auto-upgrades

- name: Disable automatic upgrades
  lineinfile:
    path: /etc/apt/apt.conf.d/20auto-upgrades
    regexp: '^APT::Periodic::Unattended-Upgrade'
    line: 'APT::Periodic::Unattended-Upgrade "0";'

- name: Install packages
  package:
    state: present
    name: "{{ item }}"
  loop:
    # Codecs
    - libavcodec-extra
    # Temporarily disabled due to package conflicts.
    #- libdvd-pkg
    - ubuntu-restricted-extras
    # Drivers
    - dkms
    - hfsprogs
    - rtl8812au-dkms
    # Gaming
    - mesa-vulkan-drivers
    - mesa-vulkan-drivers:i386
    - steam
    - wine
    - winetricks
    # Multimedia
    - firefox
    - vlc
    # Network
    - curl
    - nmap
    - openssh-server
    - wget
    # Tools
    - ansible
    - clamav
    - gcc
    - git
    - lm-sensors
    - make
    - mlocate
    - ncdu
    - openjdk-8-jre
    - python3-pip
    - qdirstat
    - rsync
    - terminator
    - tlp
    - tmate
    - vim

- name: Create the file /etc/modules-load.d/linux-gaming-stick.conf
  file:
    name: /etc/modules-load.d/linux-gaming-stick.conf
    state: touch

- name: Configure kernel drivers to load on start-up
  lineinfile:
    path: /etc/modules-load.d/linux-gaming-stick.conf
    line: "{{ item }}"
  loop:
    # WiFi drivers
    - 8812au
    - 88x2b

- name: Setup SSH keys
  authorized_key:
    user: "{{ stick_user }}"
    key: "{{ item }}"
  loop: "{{ stick_ssh_keys }}"
  when: stick_ssh_keys_setup
  tags:
    - ssh

- name: Configure the SSH daemon
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^{{ item }}"
    line: "{{ item }} no"
  loop:
    - PasswordAuthentication
    - PermitRootLogin
  tags:
    - ssh

- name: Enable the SSH daemon
  systemd:
    name: sshd
    state: started
    enabled: true
  tags:
    - ssh
    - systemd
