---
- name: Disable automatic package list updates
  lineinfile:
    path: "{{ item }}"
    regexp: '^APT::Periodic::Update-Package-Lists'
    line: 'APT::Periodic::Update-Package-Lists "0";'
  loop:
    - /etc/apt/apt.conf.d/10periodic
    - /etc/apt/apt.conf.d/20auto-upgrades

- name: Disable automatic upgrades
  lineinfile:
    path: /etc/apt/apt.conf.d/20auto-upgrades
    regexp: '^APT::Periodic::Unattended-Upgrade'
    line: 'APT::Periodic::Unattended-Upgrade "0";'

- name: Disable Wayland
  ini_file:
    path: /etc/gdm3/custom.conf
    section: daemon
    option: WaylandEnable
    value: "false"
  tags:
    - wayland

- name: Install packages
  package:
    state: present
    name: "{{ item }}"
  loop:
    # Codecs
    - libavcodec-extra
    # Temporarily disabled due to package conflicts.
    #- libdvd-pkg
    - ubuntu-restricted-extras
    # Drivers
    - dkms
    - hfsprogs
    - rtl8812au-dkms
    # Gaming
    - mesa-vulkan-drivers
    - mesa-vulkan-drivers:i386
    - steam
    - wine32
    - wine
    - winetricks
    # Multimedia
    - firefox
    - vlc
    # Network
    - curl
    - nmap
    - openssh-server
    - wget
    # Tools
    - ansible
    - clamav
    - gcc
    - git
    - lm-sensors
    - make
    - mlocate
    - ncdu
    - openjdk-8-jre
    - python3-pip
    - python3-tk
    - qdirstat
    - rsync
    - terminator
    - tlp
    - tmate
    - vim
    - zstd

- name: Create the kernel module/driver settings files
  file:
    name: "{{ item }}"
    state: touch
  loop:
    - /etc/modules-load.d/linux-gaming-stick.conf
    - /etc/modprobe.d/linux-gaming-stick.conf
  tags:
    - linux_stick_drivers

- name: Configure kernel drivers to load on start-up
  lineinfile:
    path: /etc/modules-load.d/linux-gaming-stick.conf
    line: "{{ item }}"
  loop:
    # Apple keyboard and touchpad drivers
    - applespi
    # Sensors and fans
    - applesmc
    # WiFi drivers
    - 8812au
    - 88x2b
  tags:
    - linux_stick_drivers

- name: Blacklist kernel drivers
  lineinfile:
    path: /etc/modprobe.d/linux-gaming-stick.conf
    line: "blacklist {{ item }}"
  loop:
    # Bluetooth
    - apple_bl
    # WiFi
    - brcmfmac
    - brcmutil
  tags:
    - linux_stick_drivers

- name: Setup SSH keys
  authorized_key:
    user: "{{ stick_user }}"
    key: "{{ item }}"
  loop: "{{ stick_ssh_keys }}"
  when: stick_ssh_keys_setup
  tags:
    - ssh

- name: Configure the SSH daemon
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^{{ item }}"
    line: "{{ item }} no"
  loop:
    - PasswordAuthentication
    - PermitRootLogin
  tags:
    - ssh

- name: Enable the SSH daemon
  systemd:
    name: sshd
    state: started
    enabled: true
  tags:
    - ssh
    - systemd

- name: Download Google Chrome
  get_url:
    url: https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    dest: /tmp
    force: no
  tags:
    - chrome

- name: Install Google Chrome
  apt:
    deb: /tmp/google-chrome-stable_current_amd64.deb
    state: present
  tags:
    - chrome

- name: Setup FreeOffice
  tags:
    - office
  block:
    - name: Download FreeOffice
      get_url:
        url: https://www.freeoffice.com/download.php?filename=https://www.softmaker.net/down/softmaker-freeoffice-2018_978-01_amd64.deb
        dest: /tmp/softmaker-freeoffice-2018_978-01_amd64.deb

    - name: Install FreeOffice
      apt:
        deb: /tmp/softmaker-freeoffice-2018_978-01_amd64.deb
        state: present

    - name: Install FreeOffice repositories
      command: /usr/share/freeoffice2018/add_apt_repo.sh

- name: Setup Proton Glorious Eggroll (GE) edition
  when: stick_user is defined
  become: true
  become_user: "{{ stick_user }}"
  tags:
    - proton
  block:
    - name: Create compatibility tools directory
      file:
        path: "/home/{{ stick_user }}/.steam/root/compatibilitytools.d/"
        state: directory

    - name: Download Proton GE
      get_url:
        url: "{{ item.url }}"
        dest: "/home/{{ stick_user }}/.steam/root/compatibilitytools.d/"
        checksum: "{{ item.checksum }}"
        force: no
      loop:
        # This is the last release to work outside of the newer Steam Runtime (a chroot) called Soldier.
        - url: https://github.com/GloriousEggroll/proton-ge-custom/releases/download/5.9-GE-8-ST/Proton-5.9-GE-8-ST.tar.gz
          checksum: sha256:adfd6e911ac5bdf4b725444ff4815dc8688bd262cf29e19359cb508121d03c89
        - url: https://github.com/GloriousEggroll/proton-ge-custom/releases/download/6.1-GE-2/Proton-6.1-GE-2.tar.gz
          checksum: sha256:b9907e82933b52162913f90cf0748c50e1f4cdb7de3382267e65ed24aee02dfb

    - name: Extract Proton GE
      unarchive:
        src: "/home/{{ stick_user }}/.steam/root/compatibilitytools.d/{{ item }}"
        dest: "/home/{{ stick_user }}/.steam/root/compatibilitytools.d/"
        remote_src: true
      loop:
        - Proton-5.9-GE-8-ST.tar.gz
        - Proton-6.1-GE-2.tar.gz

- name: Install the Lutris repository
  command: add-apt-repository -y ppa:lutris-team/lutris
  tags:
    - lutris

- name: Install Lutris
  package:
    name: lutris
    state: present
  tags:
    - lutris
